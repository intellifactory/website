<!DOCTYPE html>
<html lang="en">
  <head>
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-1291321-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-1291321-1');
    </script>
    <title>Content-managed WebSharper apps with custom web controls and templating</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="IntelliFactory" />
    <meta property="og:title" content="Content-managed WebSharper apps with custom web controls and templating" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://intellifactory.com/user/granicz/20211230-ContentManagedWebSharperAppsWithCustomWebControlsAndTemplating" />
    <meta property="og:image" content="https://intellifactory.com/img/category3.jpg" />
    <meta property="og:description" content="" />
    <meta property="twitter:card" content="summary" />
    <meta property="twitter:site" content="@intellifactory" />
    <meta property="twitter:title" content="Content-managed WebSharper apps with custom web controls and templating" />
    <meta property="twitter:description" content="" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=DM+Sans:400,500,700&amp;subset=latin" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&amp;display=swap" />
    <link rel="stylesheet" href="/css/tailwind/tailwind.css" />
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-tailwind.png" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/highlight.min.js" type="text/javascript" charset="UTF-8"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/fsharp.min.js" type="text/javascript" charset="UTF-8"></script><link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/styles/far.min.css"></link>
<!--[if lte IE 11.0]>
<![endif]-->
<!--[if lte IE 9.0]>
<![endif]-->

    <script src="/js/main.js"></script>
  </head>
  <body class="antialiased bg-body text-body font-body">
    <div>
      <section class="px-4 lg:px-10 bg-gray-800 px-2">
        <nav class="relative flex justify-between items-center py-2"><a class="text-2xl text-white font-bold" href="/"><span>Intelli</span>            <span class="text-blue-500 -ml-1">Factory</span></a>
          <div class="lg:hidden">
            <button class="p-2 navbar-burger">
              <svg class="w-10 h-3" width="39" height="13" viewbox="0 0 39 13" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="39" height="2" rx="1" fill="#C4C4C4"></rect>
                <rect x="19" y="11" width="20" height="2" rx="1" fill="#C4C4C4"></rect>
              </svg>
            </button>
          </div>
          <div class="hidden lg:block ml-auto mr-1">
            <ul class="flex items-center text-white space-x-10">
              <li class="hoverable"><a class="text-white font-bold text-lg" href="/">Home</a></li>
              <li class="hoverable-mm"><a class="text-white font-bold text-lg">Open Source</a>
                <div class="p-6 mega-menu mb-16 sm:mb-0 shadow-xl bg-blue-700">
                  <div class="container mx-auto w-full flex flex-wrap justify-between mx-2">
                    <ul class="px-4 w-full sm:w-1/2 lg:w-1/4 pb-6 pt-6 lg:pt-3">
                      <div class="flex items-center"><img class="h-8 mb-3 mr-3" src="/images/websharper.png" alt="WebSharper" />
                        <h3 class="font-bold text-xl text-white text-bold mb-2">WebSharper</h3>
                      </div>
                      <p class="text-gray-100 text-sm">Functional, reactive .NET web applications without writing JavaScript.</p>
                      <div class="flex items-center py-3"><a href="https://websharper.com" target="_blank"><img src="/images/category3-small.jpg" /></a></div>
                    </ul>
                    <ul class="px-4 w-full sm:w-1/2 lg:w-1/4 pb-6 pt-6 lg:pt-3">
                      <div class="flex items-center"><img class="h-8 mb-3 mr-3" src="/images/bolero.png" alt="Bolero" />
                        <h3 class="font-bold text-xl text-white text-bold mb-2">Bolero</h3>
                      </div>
                      <p class="text-gray-100 text-sm">Future-proof web applications running on WebAssembly instead of JavaScript.</p>
                      <div class="flex items-center py-3"><a href="https://fsbolero.io" target="_blank"><img src="/images/category6-small.jpg" /></a></div>
                    </ul>
                    <ul class="px-4 w-full sm:w-1/2 lg:w-1/4 pb-6 pt-6 lg:pt-3">
                      <div class="flex items-center"><img class="h-8 mb-3 mr-3 fill-current text-white" src="/images/sitefi.jpg" alt="SiteFi" />
                        <h3 class="font-bold text-xl text-white text-bold mb-2">SiteFi</h3>
                      </div>
                      <p class="text-gray-100 text-sm">.NET static web apps, markdown-based, multi-user blogs and documentation sites.</p>
                      <div class="flex items-center py-3"><a href="https://github.com/granicz/SiteFi" target="_blank"><img src="/images/category4-small.jpg" /></a></div>
                    </ul>
                    <ul class="px-4 w-full sm:w-1/2 lg:w-1/4 pb-6 pt-6 lg:pt-3">
                      <div class="flex items-center"><img class="h-8 mb-3 mr-3" src="/images/if-logo.png" alt="IntelliFactory" />
                        <h3 class="font-bold text-xl text-white text-bold mb-2">IntelliFactory Labs</h3>
                      </div>
                      <p class="text-gray-100 text-sm">Miscellaneous F# tools and other material. Some relics here and there.</p>
                      <div class="flex items-center py-3">
                        <svg class="h-6 pr-3 mr-1 fill-current text-teal-300" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 20 20">
                          <path d="M20 10a10 10 0 1 1-20 0 10 10 0 0 1 20 0zm-2 0a8 8 0 1 0-16 0 8 8 0 0 0 16 0zm-8 2H5V8h5V5l5 5-5 5v-3z"></path>
                        </svg><a class="font-bold" href="https://github.com/IntelliFactory" target="_blank">GitHub</a>
                      </div>
                    </ul>
                  </div>
                </div>
              </li>
              <li class="hoverable"><a class="text-white font-bold text-lg" href="/blogs">Blogs</a></li>
              <li class="hoverable"><a class="text-white font-bold text-lg" href="/careers">Careers</a></li>
              <li class="hoverable"><a class="text-white font-bold text-lg" href="/contact">Contact</a></li>
            </ul>
          </div>
        </nav>
        <div class="hidden navbar-menu fixed top-0 left-0 bottom-0 w-5/6 max-w-sm z-50">
          <div class="navbar-backdrop fixed inset-0 bg-gray-800 opacity-80"></div>
          <nav class="relative flex flex-col py-8 h-full w-full bg-white overflow-y-auto">
            <div class="flex items-center mb-16 pr-6"><a class="ml-10 text-2xl text-gray-800 font-bold" href="/"><img class="h-7" src="/images/if-logo-long.png" alt="IntelliFactory" /></a></div>
            <div class="hamburger">
              <ul>
                <li class="mb-1 px-10 table"><a class="block pl-8 py-4 text-xl text-gray-800 hover:bg-blueGray-50 rounded-xl" href="/">Home</a></li>
                <li class="mb-1 px-10 table"><a class="block pl-8 py-4 text-xl text-gray-800 hover:bg-blueGray-50 rounded-xl">Open Source</a>
                  <ul class="inline table">
                    <li class="mb-1 px-10"><a class="block pl-8 py-4 text-xl text-gray-800 hover:bg-blueGray-50 rounded-xl" href="https://websharper.com">WebSharper</a></li>
                    <li class="mb-1 px-10"><a class="block pl-8 py-4 text-xl text-gray-800 hover:bg-blueGray-50 rounded-xl" href="https://fsbolero.io">Bolero</a></li>
                    <li class="mb-1 px-10"><a class="block pl-8 py-4 text-xl text-gray-800 hover:bg-blueGray-50 rounded-xl" href="https://github.com/granicz/SiteFi">SiteFi</a></li>
                    <li class="mb-1 px-10"><a class="block pl-8 py-4 text-xl text-gray-800 hover:bg-blueGray-50 rounded-xl" href="https://github.com/IntelliFactory">IF Labs</a></li>
                  </ul>
                </li>
                <li class="mb-1 px-10 table"><a class="block pl-8 py-4 text-xl text-gray-800 hover:bg-blueGray-50 rounded-xl" href="/blogs">Blogs</a></li>
                <li class="mb-1 px-10 table"><a class="block pl-8 py-4 text-xl text-gray-800 hover:bg-blueGray-50 rounded-xl" href="/careers">Careers</a></li>
                <li class="mb-1 px-10 table"><a class="block pl-8 py-4 text-xl text-gray-800 hover:bg-blueGray-50 rounded-xl" href="/contact">Contact</a></li>
              </ul>
            </div>
            <div class="mt-auto px-10">
              <p class="mt-6 mb-4 text-lg text-center"><span>2004-2021 © IntelliFactory. All rights reserved.</span></p>
            </div>
          </nav>
        </div>
      </section>
      
      <section class="relative py-20 2xl:py-40 overflow-hidden">
        <div class="container px-4 mx-auto">
          <div class="max-w-4xl mx-auto text-center">
            <h2 class="bg-opacity-25 bg-gray-900 mb-14 text-6xl lg:text-7xl font-bold font-heading text-white">Content-managed WebSharper apps with custom web controls and templating</h2>
          </div><img class="absolute top-0 left-0 w-full h-full object-cover" style="z-index:-10;" src="/img/category3.jpg" alt="" />
        </div>
      </section>
      <section class="relative py-10 overflow-hidden bg-blueGray-100">
        <div class="container px-4 mx-auto">
          <div class="max-w-4xl mx-auto text-center">
            <div class="inline-flex items-center flex-wrap"><a href="/user/granicz"><img class="mr-8 w-20 lg:w-24 h-20 lg:h-24 rounded-full" src="/img/avatar/granicz.png" alt="Adam Granicz" /></a>
              <div class="flex-1 text-left"><a href="/user/granicz">
                  <h4 class="mb-1 text-2xl font-bold">Adam Granicz</h4></a>
                <p>Dec 30, 2021</p>
              </div>
              <div class="text-right ml-20 flex-1 flex-basis-100">
                <p class="mb-1 font-bold text-xl">Reading time:</p>
                <p>20 mins</p>
              </div>
              <div class="text-right ml-20 mt-3 flex-1 flex-basis-100">
                <p class="mb-1 font-bold text-xl">Share via:</p>
                <div><a class="inline-block mr-2" href="https://twitter.com/intent/tweet?text=Content-managed+WebSharper+apps+with+custom+web+controls+and+templating&amp;url=https%3a%2f%2fintellifactory.com%2fuser%2fgranicz%2f20211230-ContentManagedWebSharperAppsWithCustomWebControlsAndTemplating">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewbox="0 0 24 24" fill="#00acee">
                      <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"></path>
                    </svg></a>                  <a class="inline-block mr-2" href="https://www.linkedin.com/sharing/share-offsite/?url=https%3a%2f%2fintellifactory.com%2fuser%2fgranicz%2f20211230-ContentManagedWebSharperAppsWithCustomWebControlsAndTemplating">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewbox="0 0 24 24" fill="#0e76a8">
                      <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-2 16h-2v-6h2v6zm-1-6.891c-.607 0-1.1-.496-1.1-1.109 0-.612.492-1.109 1.1-1.109s1.1.497 1.1 1.109c0 .613-.493 1.109-1.1 1.109zm8 6.891h-1.998v-2.861c0-1.881-2.002-1.722-2.002 0v2.861h-2v-6h2v1.093c.872-1.616 4-1.736 4 1.548v3.359z"></path>
                    </svg></a>                  <a class="inline-block" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fintellifactory.com%2fuser%2fgranicz%2f20211230-ContentManagedWebSharperAppsWithCustomWebControlsAndTemplating">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewbox="0 0 24 24" fill="#3b5998">
                      <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm3 8h-1.35c-.538 0-.65.221-.65.778v1.222h2l-.209 2h-1.791v7h-3v-7h-2v-2h2v-2.308c0-1.769.931-2.692 3.029-2.692h1.971v3z"></path>
                    </svg></a></div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <section class="py-20 bg-white overflow-hidden">
        <div class="container px-4 mx-auto">
          <div class="max-w-4xl mx-auto markdown"><div ws-preserve=""><p>(This post is part of <a href="https://sergeytihon.com/2021/10/18/f-advent-calendar-2021/">F# Advent</a>, a huge thanks to <a href="https://github.com/sergey-tihon">Sergey Tihon</a> for organizing!)</p>
<p>A while ago I gave a talk at <a href="https://skillsmatter.com/conferences/13254-f-sharp-exchange-2021">F# Exchange 2021</a>, where I discussed how WebSharper <a href="https://developers.websharper.com/docs/v4.x/fs/sitelets">sitelets</a> can be extended with a CMS primitive that allows sitelet pages to be &quot;content managed.&quot; This has some major implications on how you could design more maintainable content-centric web applications by enabling runtime access to their (designated) content.</p>
<p>In this article, I will discuss the details of making the underlying CMS web controls and give some insights on making the most of WebSharper web controls and UI templates.</p>
<blockquote>
<p>You can follow along and run the entire app via:</p>
<ol>
<li><code>git clone https://github.com/granicz/BlogWithCMS</code></li>
<li><code>cd MyBlog</code></li>
<li><code>dotnet run</code></li>
</ol>
</blockquote>
<p>Below is what our final app looks like with the CMS functionality applied on a micro blogging app, showing the results in two tabs: viewing a given post in one and editing it in another:</p>
<p><img src="https://github.com/IntelliFactory/blogs/raw/master/assets/BlogWithCMS-EditAndView.gif" alt="Our final app" /></p>
<h2 id="web-controls">Web controls</h2>
<p>WebSharper web controls go way back to ASP.NET where they served as a bridge between client-side/dynamic content/behavior and ASP.NET server-side markup (you can read more on the <a href="https://developers.websharper.com/docs/v4.x/fs/aspnet">ASP.NET page</a> of the documentation.) They do so by providing a <code>System.Web.Control</code> derivative type called <code>WebSharper.Web.Control</code>, which you can inherit from to create your own server-side controls.</p>
<p>The main thing to remember with web controls, though, is that they are merely a placeholder when rendered on the server, and they light up automatically on the client by evaluating their <code>Body</code> property (as indicated by the <code>[&lt;JavaScript&gt;]</code> annotation), and embedding the result into this placeholder. In other words, the content appears shortly after loading the page, causing a visual flicker.</p>
<p>Consider the following snippet to implement a custom button control:</p>
<pre><code class="language-fsharp">open WebSharper
open WebSharper.JavaScript
open WebSharper.UI.Html

type MyButton() =
    inherit Web.Control()

    [&lt;JavaScript&gt;]
    override this.Body =
        button [
            on.click (fun _ _ -&gt; JS.Alert &quot;clicked!&quot;)
        ] [text &quot;Hello world!&quot;] :&gt; _
</code></pre>
<p>To embed an instance of this web control into your UI markup, you can use <code>Doc.WebControl</code>:</p>
<pre><code class="language-fsharp">div [] [Doc.WebControl &lt;| MyButton()]
</code></pre>
<h2 id="server-side-rendering-of-web-controls">Server-side rendering of web controls</h2>
<p>Another way to build web controls is simply by representing them as WebSharper.UI <code>Doc</code> values. <code>Doc</code> and <code>Elt</code> are the main representations of DOM nodes and any dynamic behavior associated with them. The added benefit of building from <code>Doc</code> is that the resulting controls can be rendered on the server as well, avoiding the visual flicker we saw earlier with <code>Web.Control</code> instances, although more advanced reactive functionality can only be applied from client-side code. More on that on the <a href="https://developers.websharper.com/docs/v4.x/fs/ui">UI documentation page</a>.</p>
<p>Given this, the previous example becomes:</p>
<pre><code class="language-fsharp">open WebSharper.UI
open WebSharper.UI.Html

type Doc with
    static member MyButton() =
        button [
            on.click (fun e arg -&gt; JS.Alert &quot;clicked!&quot;)
        ] [text &quot;Hello world!&quot;]
</code></pre>
<p>Embedding this control is more straightforward as well, and now the entire control is rendered on the server:</p>
<pre><code class="language-fsharp">div [] [Doc.MyButton()]
</code></pre>
<h2 id="templating">Templating</h2>
<p>Writing HTML as inline F# code as shown above is rarely the best approach, because changing the HTML (which you will need more often than you think) requires recompilation. While you can apply seemingly clever tactics to get around having to wait for compilation, such as watching source files and recompiling in the background, or even keeping the compiler in memory to speed up compilation, you are still paying the cost somewhere and your machine is doing mostly unnecessary work. Instead, I usually place HTML into template files and use the templating TP to work with it:</p>
<pre><code class="language-fsharp">open WebSharper.UI.Templating

type MainTemplate = Template&lt;&quot;main.html&quot;, serverLoad=ServerLoad.WhenChanged&gt;
</code></pre>
<p>This is the more verbose invocation, you can just name the file and be done with it. In the above code, we also want any server-side code to use the latest update to the template, i.e. we should automatically reload the template when it changes. Using the TP relieves you from having to recompile on HTML changes, and instead it will manage refreshing when needed.</p>
<p>The templating TP looks for special WebSharper markers (<code>ws-..</code> attributes for content placeholders, event handlers, and model bindings) in the specified source file(s), that you can read about in the &quot;HTML Templates&quot; section of the <a href="https://developers.websharper.com/docs/v4.x/fs/ui">UI documentation page</a>, and exposes various types and members in the resulting type space.</p>
<p>For the CMS functionality in my F# Exchange talk, I built two separate controls - you can see both in the animation above, here are their templates:</p>
<ol>
<li><p>The &quot;in-place&quot; editor is a simple template with a placeholder for the inner content (<code>TextContent</code>) and an <code>OnAfterRender</code> (OAR) handler to initialize it according to our needs (planting the <code>contenteditable</code> attribute). Saving takes place upon losing focus to keep things simple.</p>
<pre><code class="language-html">&lt;div class=&quot;editor-container&quot; ws-template=&quot;InPlaceEditor&quot; ws-onafterrender=&quot;OnAfterRender&quot; ws-hole=&quot;TextContent&quot;&gt;&lt;/div&gt;
</code></pre>
</li>
<li><p>The plain editor version is slightly more elaborate: it provides a loading indicator so we can tell when it's working in the background, and an actual textarea control to do the editing along with a Save button to send it back to the data store on the server.</p>
<pre><code class="language-html">&lt;div class=&quot;editor-container&quot; ws-template=&quot;Editor&quot; ws-onafterrender=&quot;OnAfterRender&quot;&gt;
  &lt;div class=&quot;loader-container ${LoaderCssClass}&quot;&gt;
      &lt;div class=&quot;loader&quot;&gt;&lt;/div&gt;
  &lt;/div&gt;
  &lt;div class=&quot;editor&quot;&gt;
    &lt;textarea type=&quot;text&quot; ws-var=&quot;TextContent&quot;&gt;&lt;/textarea&gt;
    &lt;div class=&quot;overlay&quot;&gt;
      &lt;button ws-onclick=&quot;Save&quot;&gt;Save&lt;/button&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
</li>
</ol>
<p>For instance, you could go about instantiating the <code>InPlaceEditor</code> template with the folowing code:</p>
<pre><code class="language-fsharp">MainTemplate.InPlaceEditor()               // Inner template
    .TextContent(&quot;Hello&quot;)                  // Placeholder
    .OnAfterRender(fun e -&gt; DoSomething()) // Event handler
    ...
    .Doc()                                 // Seal and return as `Doc`
</code></pre>
<p>Note the type of <code>e</code> in the event handler: it's <code>Runtime.Server.TemplateEvent</code> instantiated over two types: <code>MainTemplate.InPlaceEditor.Vars</code> and <code>Dom.Event</code>. You can use the former to access the template model (<code>.Vars</code>)- i.e. any model-bound input controls via <code>ws-var</code>, the event info (<code>.Event</code>), and the target DOM node of the event (<code>.Target</code>). These members provide type-safe access to the underlying entities, and they are especially useful to read/populate templated form data.</p>
<h2 id="the-cms-function">The CMS function</h2>
<p>It turns out, it's not that easy to just provide a &quot;CMS combinator&quot; that takes any sitelet, enhances its pages with CMS capabilities and returns the result as a new sitelet. Just think of sitelets representing REST endpoints, serving non-HTML content, etc. Instead, to avoid the complexities involved in recognizing sitelet responses, we build on a simpler function to enhance from, one whose signature is:</p>
<pre><code class="language-fsharp">Context&lt;'T&gt; -&gt; inEdit:bool -&gt; 'T -&gt; Doc
</code></pre>
<p>Armed with a server-side <code>render</code> function of the above signature, we can write our CMS function returning a <code>Sitelet&lt;CMS&lt;'T&gt;&gt;</code>:</p>
<pre><code class="language-fsharp">module CMS =
    type CMS&lt;'T&gt; =
        | [&lt;EndPoint &quot;/edit&quot;&gt;] Edit of 'T
        | [&lt;EndPoint &quot;/&quot;&gt;] View of 'T

    let AddCMS (render: Context&lt;'T&gt; -&gt; bool -&gt; 'T -&gt; Doc) : Sitelet&lt;CMS&lt;'T&gt;&gt; =
        Sitelet.Infer (fun (ctx: Context&lt;CMS&lt;'T&gt;&gt;) -&gt; function
            | Edit (page: 'T) -&gt;
                Content.Page (render (Context.Map Edit ctx) true page)
            | View (page: 'T) -&gt;
                Content.Page (render (Context.Map View ctx) false page)
        )
</code></pre>
<p>Here, <code>'T</code> is our regular sitelet endpoint type, so we are essentially changing the URL schema of our application from <code>'T</code> to <code>CMS&lt;'T&gt;</code>, as you'd expect. Next to the original URLs (now mapped over themselves under <code>View of 'T</code>), there will now be an <code>/edit/...</code> URL for every URL in our inner endpoint type, showing content in &quot;edit&quot; mode. Now, we just need to create such smart content - and that's where our CMS controls come into play.</p>
<p><code>AddCMS</code> simply calls the provided <code>render</code> function to render each sitelet page in both edit and view modes, passing down the <code>inEdit</code> boolean value, accordingly. This can then be used in the actual render function, and we'll see that shortly.</p>
<h2 id="data-store">Data store</h2>
<p>Our data store for CMS content is file-based, we simply stick each key-value pair into a <code>store</code> folder (key becomes the file name, value becomes its content.) The names of the keys are important, and they will be determined by the actual CMS control instances.</p>
<pre><code class="language-fsharp">module MyFileCMS =
    open System.IO

    let Write (sourceFolder, key, newValue) =
        let fname = sprintf &quot;%s/store/%s.html&quot; sourceFolder key
        // Check whether target directory exists, if not, create it
        let dir = Path.GetDirectoryName fname
        if not &lt;| Directory.Exists dir then
            Directory.CreateDirectory dir |&gt; ignore
        File.WriteAllText(fname, newValue)

    let Read (sourceFolder, key) =
        let fname = sprintf &quot;%s/store/%s.html&quot; sourceFolder key
        if File.Exists fname then
            Some &lt;| File.ReadAllText fname
        else
            None
</code></pre>
<h2 id="backend">Backend</h2>
<p>The server consists of two RPC functions that wrap reading/writing our data store, passing down the root folder of the main web app so the store can read the correct <code>store</code> folder:</p>
<pre><code class="language-fsharp">module Server =
    [&lt;Rpc&gt;]
    let WriteContent (key: string, newValue) =
        let ctx = Web.Remoting.GetContext()
        async {
            return MyFileCMS.Write(ctx.RootFolder, key, newValue)
        }

    [&lt;Rpc&gt;]
    let ReadContent key = 
        let ctx = Web.Remoting.GetContext()
        async {
            return MyFileCMS.Read(ctx.RootFolder, key)
        }
</code></pre>
<h2 id="control-1-the-in-place-editor-doc.managedcontentwithinplaceeditor">Control #1 - The in-place editor: <code>Doc.ManagedContentWithInPlaceEditor</code></h2>
<p>Our in-place editor control has two main chores after rendering itself: registering an <code>OnBlur</code> event handler to save the current contents back into our data store (note that we are not doing anything about detecting actual changes, although this would be easy to add) and setting up the <code>contenteditable</code> attribute on the parent element.</p>
<pre><code class="language-fsharp">type Doc with
    /// A UI control that can edit its content on demand.
    /// It must be attached to a container node (p, div, etc.)
    static member ManagedContentWithInPlaceEditor (ctx: Context&lt;_&gt;, inEdit) (key, defValue) =
        let v = MyFileCMS.Read(ctx.RootFolder, key)
        let content = ...
        if inEdit then
            MainTemplate.InPlaceEditor()
                .OnAfterRender(fun (e: Runtime.Server.TemplateEvent&lt;MainTemplate.InPlaceEditor.Vars, _&gt;) -&gt;
                    ...
                    // Auto-save when container/editor node loses focus
                    e.Target.ParentElement.AddEventListener(&quot;blur&quot;,
                        new System.Action&lt;Dom.Event&gt;(fun e -&gt;
                            let content = ..
                            async {
                                do! Server.WriteContent(key, content)
                            } |&gt; Async.Start
                        ))
                    // Make the parent control editable
                    e.Target.ParentElement.SetAttribute(&quot;contenteditable&quot;, &quot;true&quot;)
                )
                .TextContent(Doc.Verbatim content)
                .Doc()
        else
            if v.IsNone &amp;&amp; defValue.IsNone then
                Doc.Empty
            else
                Doc.Verbatim content
</code></pre>
<h2 id="control-2-the-text-editor-doc.managedcontent">Control #2 - The text editor: <code>Doc.ManagedContent</code></h2>
<p>Our text editor control has its own CSS, so we add that as a resource to be tracked (you can read more about handling resources on the <a href="https://developers.websharper.com/docs/v4.x/fs/resources">Resources page</a> in the documentation):</p>
<pre><code class="language-fsharp">type ManagedContentResource() =
    inherit Resources.BaseResource(&quot;WebSharper.CMS.css.ManagedContent.css&quot;)
</code></pre>
<p>The string passed to <code>BaseResource</code> above reflects the fact that I have the CMS control in a separate project (<code>WebSharper.CMS</code>) with a <code>css</code> folder, and a file inside called <code>ManagedContent.css</code>. Note the use of <code>Web.Require</code> in the control's definition below, taking care of auto-including it whereever we use this control.</p>
<pre><code class="language-fsharp">type Doc with
    [&lt;Require(typeof&lt;ManagedContentResource&gt;)&gt;]
    static member ManagedContent (ctx: Context&lt;_&gt;, inEdit) (key, defValue) =
        let v = MyFileCMS.Read(ctx.RootFolder, key)
        let content = ...
        if inEdit then
            Doc.Concat [
                MainTemplate.Editor()
                    .OnAfterRender(fun (e: Runtime.Server.TemplateEvent&lt;MainTemplate.Editor.Vars, _&gt;) -&gt;
                        async {
                            ...
                            // Retrieve saved value for our given key
                            let! res = Server.ReadContent key
                            do if res.IsSome then e.Vars.TextContent := res.Value
                            ...
                        }
                        |&gt; Async.Start
                    )
                    .Save(fun (e: Runtime.Server.TemplateEvent&lt;MainTemplate.Editor.Vars, _&gt;) -&gt;
                        ...
                        // Save what's in the editor
                        async {
                            do! Server.WriteContent(key, e.Vars.TextContent.Value)
                            ...
                            ) |&gt; ignore
                        } |&gt; Async.Start
                    )
                    .TextContent(content)
                    .Doc()
                // Add the control's CSS file as a resource.
                Doc.WebControl &lt;| Web.Require(typeof&lt;ManagedContentResource&gt;)
            ]
        else
            if v.IsNone &amp;&amp; defValue.IsNone then
                Doc.Empty
            else
                text content
</code></pre>
<h2 id="putting-things-together">Putting things together</h2>
<p>At this point, things go really fast and all we need is to &quot;put everything together.&quot; But don't worry, it's quite easy with all the pieces prepared already. First, we need a designer template so our CMS-driven blog looks reasonable.</p>
<h3 id="preparing-your-designer-template">Preparing your designer template</h3>
<p>I grabbed the excellent and free HTML+CSS template &quot;Mediumish&quot; from free-css.com:</p>
<pre><code class="language-text">https://www.free-css.com/free-css-templates/page271/mediumish
</code></pre>
<p>Among others, this comes with a <code>post.html</code> and an <code>assets</code> folder with JS/CSS/image assets, making it super-easy to reuse. I then planted two placeholders, one for a post's title and one for its content, replacing the text in both with a <code>ws-hole</code> attribute on the parent node:</p>
<pre><code class="language-html">&lt;!-- post.html --&gt;
&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
  ...
  &lt;!-- Make sure asset references start with root --&gt;
  &lt;link href=&quot;/assets/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;
  ...
  &lt;link href=&quot;/assets/css/mediumish.css&quot; rel=&quot;stylesheet&quot;&gt;
&lt;/head&gt;
&lt;body&gt;

  &lt;div class=&quot;container&quot;&gt;
    &lt;div class=&quot;row&quot;&gt;
      ...
      &lt;!-- Begin Post --&gt;
      &lt;div class=&quot;...&quot;&gt;
        &lt;div class=&quot;...&quot;&gt;
          ...
          &lt;!-- Title --&gt;
          &lt;h1 class=&quot;posttitle&quot; ws-hole=&quot;Title&quot;&gt;&lt;/h1&gt;
        &lt;/div&gt;
        ...
        &lt;!-- Content --&gt;
        &lt;div class=&quot;article-post&quot; ws-hole=&quot;Content&quot;&gt;&lt;/div&gt;
        ...
  ...
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>We can now bring this template in for our F# needs:</p>
<pre><code class="language-fsharp">type PostTemplate = Template&lt;&quot;post.html&quot;, serverLoad=ServerLoad.WhenChanged&gt;
</code></pre>
<h3 id="building-a-sitelet-for-our-app">Building a sitelet for our app</h3>
<p>Amazingly, we are just now getting to actually creating the main app. We can model our mini blog with two kinds of pages: a home page and the article/post pages:</p>
<pre><code class="language-fsharp">type EndPoint =
    | [&lt;EndPoint &quot;/&quot;&gt;] Home
    | [&lt;EndPoint &quot;/post&quot;&gt;] Post of slug:string
</code></pre>
<p>Keep in mind, that <code>AddCMS</code> expects a <code>render</code> function of a particular shape, we can write that function first and simply call <code>AddCMS</code> on it:</p>
<pre><code class="language-fsharp">[&lt;Website&gt;]
let Main =  // Sitelet&lt;CMS&lt;EndPoint&gt;&gt;
    fun ctx (inEdit: bool) -&gt; function
        | Home -&gt;
            ...
        | Post slug -&gt;
            PostTemplate()
                .Title(
                    Doc.ManagedContent (ctx, inEdit) (&quot;title_&quot; + slug, Some &lt;| sprintf &quot;This is blog post %s&quot; slug)
                )
                .Content(
                    Doc.ManagedContentWithInPlaceEditor (ctx, inEdit) (&quot;post_&quot; + slug, None)
                )
                .Doc()
    |&gt; CMS.AddCMS
</code></pre>
<p>Here we applied our textarea edit control for the title and the in-place editor for the content, and our app now looks like the screenshot in the beginning of this article. (To make this sitelet actually work, <code>Startup.fs</code> takes care of embedding it into an ASP.NET Core app.)</p>
<p>Note how the two CMS controls set the names of the keys for title/content for each blog post. For instance, the key for the title content of a blog page whose slug is <code>3</code> will be <code>title_3</code>, etc. The second argument in that tuple gives a default value, if the key is not yet in the content store.</p>
<h2 id="things-to-explore-further">Things to explore further</h2>
<p>Obviously, we only scratched the surface of what could be accomplished, and here are a few more ideas to try:</p>
<ol>
<li><p>Markdown content blocks: in addition to storing page content as HTML, you could also provide saving and editing it as Markdown.</p>
</li>
<li><p>Adding an offline sitelet for generating a static version of the blog, which could then be uploaded to GitHub Pages, Azure Static Web Apps or other web hosts. You should also check out <a href="https://github.com/granicz/SiteFi">SiteFi</a> for that.</p>
</li>
<li><p>Hosting the main sitelet outside WebSharper, say in Giraffe or Saturn. This is best done with the experimental &quot;general&quot; <a href="https://github.com/IntelliFactory/sitelets">sitelets library</a>.</p>
</li>
<li><p>Creating more elaborate editors.</p>
</li>
<li><p>Moving the backend data store to a database.</p>
</li>
</ol>
<p>Happy coding and Happy Holidays!</p>
</div></div>
        </div>
      </section>
      <section class="py-20 bg-white">
        <div class="container px-4 mx-auto">
          <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-12">
            <div class="lg:w-2/3 lg:pr-16 mb-2 lg:mb-8">
              <h2 class="text-3xl md:text-4xl font-bold font-heading">Read more from </h2>
            </div>
            <div class="text-sm lg:text-base lg:w-1/3">
              <p class="leading-loose text-blueGray-500"><span>Can’t find what you were looking for? </span>                <a class="text-blue-600 hover:text-blue-700" href="/contact">Drop us a line</a>.
                              
              </p>
            </div>
          </div>
          <div class="flex flex-wrap -mx-4">
            <div class="w-full md:w-1/2 lg:w-1/4 px-4 mb-8"><a href="/user/granicz">
                <div class="inline-flex items-center"><img class="mr-2 w-4 h-4 lg:w-8 lg:h-8 rounded-full" src="/img/avatar/granicz.png" alt="Adam Granicz" />
                  <div class="flex-1 text-left"><span class="text-lg font-bold text-blueGray-400">Adam Granicz</span></div>
                </div></a>              <a href="/user/granicz/20221229-full-stack-fsharp-with-charting-reactive-forms-and-more-under-300-loc-with-websharper">
                <h4 class="text-xl font-semibold">Full-stack F# with charting, reactive forms, and more under 300 LOC with WebSharper</h4></a>
              <p class="text-sm md:text-base text-blueGray-400">20221229 · 30 min read</p>
            </div><div class="w-full md:w-1/2 lg:w-1/4 px-4 mb-8"><a href="/user/granicz">
                <div class="inline-flex items-center"><img class="mr-2 w-4 h-4 lg:w-8 lg:h-8 rounded-full" src="/img/avatar/granicz.png" alt="Adam Granicz" />
                  <div class="flex-1 text-left"><span class="text-lg font-bold text-blueGray-400">Adam Granicz</span></div>
                </div></a>              <a href="/user/granicz/20201231-variations-for-a-websharper-shopping-cart">
                <h4 class="text-xl font-semibold">Variations for a WebSharper shopping cart</h4></a>
              <p class="text-sm md:text-base text-blueGray-400">20201231 · 48 min read</p>
            </div><div class="w-full md:w-1/2 lg:w-1/4 px-4 mb-8"><a href="/user/granicz">
                <div class="inline-flex items-center"><img class="mr-2 w-4 h-4 lg:w-8 lg:h-8 rounded-full" src="/img/avatar/granicz.png" alt="Adam Granicz" />
                  <div class="flex-1 text-left"><span class="text-lg font-bold text-blueGray-400">Adam Granicz</span></div>
                </div></a>              <a href="/user/granicz/20200116-converting-a-websharper-html-app-to-a-client-server-one">
                <h4 class="text-xl font-semibold">Converting a WebSharper HTML app to a client-server one</h4></a>
              <p class="text-sm md:text-base text-blueGray-400">20200116 · 5 min read</p>
            </div><div class="w-full md:w-1/2 lg:w-1/4 p-4 mb-8 bg-gray-50 rounded-3xl"><a href="https://github.com/IntelliFactory/blogs/tree/master/user/granicz/20211230-ContentManagedWebSharperAppsWithCustomWebControlsAndTemplating.md">
                <div class="inline-flex items-center"><img class="mr-2 w-4 h-4 lg:w-8 lg:h-8 rounded-full" src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="Adam Granicz" />
                  <div class="flex-1 text-left"><span class="text-lg font-bold text-blueGray-400">Found a typo?</span></div>
                </div></a>
              <h4 class="text-xl font-semibold">This blog post is hosted on GitHub <a href="https://github.com/IntelliFactory/blogs/tree/master/user/granicz/20211230-ContentManagedWebSharperAppsWithCustomWebControlsAndTemplating.md">here</a>. Feel free to file a ticket or send a PR.</h4>
            </div>
            
            
          </div>
        </div>
      </section>
      
      
      <section class="2xl:pt-16 xl:pb-8 py-5 bg-blueGray-50">
        <div class="container mx-auto px-4">
          <div class="flex flex-wrap border-b border-gray-100 pt-5 lg:pt-10">
            <div class="w-full lg:w-3/5 px-4">
              <div class="flex flex-wrap px-5 pb-4">
                <div class="w-1/2 lg:w-1/3 mb-12">
                  <h3 class="mb-8 lg:mb-10 text-xl font-bold font-heading">IntelliFactory</h3>
                  <ul class="text-lg">
                    <li class="mb-4"><a class="hover:underline" href="/blogs">Blogs</a></li>
                    <li class="mb-4"><a class="hover:underline" href="/careers">Careers</a></li>
                    <li><a href="/contact">Contact</a></li>
                  </ul>
                </div>
                <div class="w-full lg:w-1/3 px-4 mb-4">
                  <h3 class="mb-8 lg:mb-10 text-xl font-bold font-heading">Services</h3>
                  <ul class="text-lg">
                    <li class="mb-4"><a class="hover:underline" href="/home#consulting">Consulting</a></li>
                    <li class="mb-4"><a class="hover:underline" href="/home#trainings">Trainings</a></li>
                    <li class="mb-4"><a class="hover:underline" href="/home#code-synthesis">AI-driven Code Synthesis</a></li>
                    <li class="mb-4"><a class="hover:underline" href="/home#dsls">Domain-Specific Languages</a></li>
                  </ul>
                </div>
                <div class="w-1/2 lg:w-1/3 px-4 mb-12">
                  <h3 class="mb-8 lg:mb-10 text-xl font-bold font-heading">Open Source</h3>
                  <ul class="text-lg">
                    <li class="mb-4"><a class="hover:underline" href="https://websharper.com">WebSharper</a></li>
                    <li class="mb-4"><a class="hover:underline" href="https://fsbolero.io">Bolero</a></li>
                    <li class="mb-4"><a class="hover:underline" href="#">From our Lab</a></li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="w-full lg:w-2/5 px-4 order-first lg:order-last mb-16 lg:mb-0">
              <h3 class="mb-10 text-xl font-bold">Newsletter</h3>
              <form method="post" id="newsletter-form">
                <div class="md:max-w-sm mb-8 flex items-center bg-white border border-gray-100 rounded-full"><span class="inline-block pl-2 lg:pl-5">
                    <svg width="37" height="37" viewbox="0 0 37 37" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="18.5" cy="18.5" r="9.5" fill="#1F40FF" fill-opacity="0.15"></circle>
                      <circle cx="18.5" cy="18.5" r="18.5" fill="#1F40FF" fill-opacity="0.06"></circle>
                      <circle cx="18.5" cy="18.5" r="2.5" fill="#282C36"></circle>
                    </svg></span>
                  <input id="newsletter-input" class="pl-4 py-2 focus:outline-none rounded-full placeholder-gray-900 font-bold" type="email" placeholder="Your email address" />
                  <button id="signup" class="ml-auto px-6 lg:px-8 py-4 text-white font-bold bg-blue-500 hover:bg-blue-600 rounded-full transition duration-200">Ok</button>
                </div>
                <div id="newsletter-alert-list"></div>
                <p class="text-gray-300">We will not spam you or give your details to anyone.</p>
              </form>
            </div>
          </div>
          <div class="flex flex-wrap items-center mb-8 lg:mb-0 pt-5">
            <div class="hidden md:block w-full md:w-3/4 mb-8 md:mb-0">
              <div class="md:flex items-center"><a class="inline-block text-gray-900 text-xl font-bold" href="#"><img class="h-7" src="/images/if-logo-long.png" alt="IntelliFactory" width="auto" /></a>              <span class="hidden md:inline-block mx-8 w-px h-8 bg-gray-50"></span>
                <p class="hidden lg:block text-sm text-gray-300"><span class="text-gray-700">Copyright © 2004-2021 IntelliFactory.</span>                All rights reserved. Made with
                                  <img width="16" height="20" style="display:inline;vertical-align:middle;" alt="Love" src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/42/Love_Heart_SVG.svg/32px-Love_Heart_SVG.svg.png" />                in 100% F#.
                                
                </p>
              </div>
            </div>
            <div class="w-full md:w-1/4">
              <div class="md:flex items-center justify-end"><a class="inline-block mr-2" href="https://github.com/intellifactory">
                  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewbox="0 0 24 24">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path>
                  </svg></a>              <a class="inline-block mr-2" href="https://facebook.com/intellifactory">
                  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewbox="0 0 24 24" fill="#3b5998">
                    <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm3 8h-1.35c-.538 0-.65.221-.65.778v1.222h2l-.209 2h-1.791v7h-3v-7h-2v-2h2v-2.308c0-1.769.931-2.692 3.029-2.692h1.971v3z"></path>
                  </svg></a>              <a class="inline-block mr-2" href="https://twitter.com/intellifactory">
                  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewbox="0 0 24 24" fill="#00acee">
                    <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"></path>
                  </svg></a>              <a class="inline-block mr-2" href="https://www.linkedin.com/company/intellifactory">
                  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewbox="0 0 24 24" fill="#0e76a8">
                    <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-2 16h-2v-6h2v6zm-1-6.891c-.607 0-1.1-.496-1.1-1.109 0-.612.492-1.109 1.1-1.109s1.1.497 1.1 1.109c0 .613-.493 1.109-1.1 1.109zm8 6.891h-1.998v-2.861c0-1.881-2.002-1.722-2.002 0v2.861h-2v-6h2v1.093c.872-1.616 4-1.736 4 1.548v3.359z"></path>
                  </svg></a>              <a class="inline-block" href="https://vimeo.com/user15828007">
                  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewbox="0 0 24 24" fill="#86c9ef">
                    <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.82 11.419c-1.306 2.792-4.463 6.595-6.458 6.595-1.966 0-2.25-4.192-3.324-6.983-.527-1.372-.868-1.058-1.858-.364l-.604-.779c1.444-1.27 2.889-2.745 3.778-2.826.998-.096 1.615.587 1.845 2.051.305 1.924.729 4.91 1.472 4.91.577 0 2.003-2.369 2.076-3.215.13-1.24-.912-1.277-1.815-.89 1.43-4.689 7.383-3.825 4.888 1.501z"></path>
                  </svg></a></div>
            </div>
          </div>
        </div>
      </section>
      
      <div>
        
        <meta id='websharper-data' name='websharper-data' content='{"$TYPES":[],"$DATA":{"$V":{}}}' />
<script src="../../Scripts/WebSharper.Core.JavaScript/Runtime.js" type="text/javascript" charset="UTF-8"></script><script type="text/javascript">
if (typeof IntelliFactory !=='undefined') {
  IntelliFactory.Runtime.ScriptBasePath = '../../Scripts/';
  IntelliFactory.Runtime.Start();
}
</script>

        <script src="/js/Dynamic.js"></script>
      </div>
    </div>
  </body>
</html>