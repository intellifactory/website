<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Deploying a .NET Core WebSharper site in AWS Lambda</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=DM+Sans:400,500,700&amp;amp;subset=latin" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&amp;amp;display=swap" />
    <link rel="stylesheet" href="/css/tailwind/tailwind.min.css" />
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-tailwind.png" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/highlight.min.js" type="text/javascript" charset="UTF-8"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/languages/fsharp.min.js" type="text/javascript" charset="UTF-8"></script><link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.14.2/styles/far.min.css"></link>

    <script src="/js/main.js"></script>
  </head>
  <body class="antialiased bg-body text-body font-body">
    <div>
      <div>
        <section class="px-4 lg:px-10 bg-gray-800 px-2">
          <nav class="relative flex justify-between items-center py-2"><a class="text-2xl text-white font-bold" href="#"><img style="height:3rem;margin:-0.65rem 0 -0.65rem 0;" src="/img/if-logo.png" alt="IntelliFactory" /></a>
            <div class="lg:hidden">
              <button class="p-2 navbar-burger">
                <svg class="w-10 h-3" width="39" height="13" viewbox="0 0 39 13" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect width="39" height="2" rx="1" fill="#C4C4C4"></rect>
                  <rect x="19" y="11" width="20" height="2" rx="1" fill="#C4C4C4"></rect>
                </svg>
              </button>
            </div>
            <div class="hidden lg:block ml-auto mr-16">
              <ul class="flex items-center text-white space-x-10">
                <li><a class="text-white font-bold text-lg" href="/">Home</a></li>
                <li><a class="text-white font-bold text-lg" href="/oss">Open Source</a></li>
                <li><a class="text-white font-bold text-lg" href="/blogs">Blogs</a></li>
                <li><a class="text-white font-bold text-lg" href="/contact">Contact</a></li>
              </ul>
            </div>
            <div class="hidden lg:block"><a class="inline-block px-12 text-white font-bold border border-gray-200 hover:border-white rounded-full py-2" href="#">Sign Up</a></div>
          </nav>
          <div class="hidden navbar-menu fixed top-0 left-0 bottom-0 w-5/6 max-w-sm z-50">
            <div class="navbar-backdrop fixed inset-0 bg-gray-800 opacity-80"></div>
            <nav class="relative flex flex-col py-8 h-full w-full bg-white overflow-y-auto">
              <div class="flex items-center mb-16 pr-6"><a class="ml-10 text-2xl text-gray-800 font-bold" href="#"><img class="h-7" src="/img/if-logo-long.png" alt="IntelliFactory" /></a></div>
              <div>
                <ul>
                  <li class="mb-1 px-10"><a class="block pl-8 py-4 text-xl text-gray-800 hover:bg-blueGray-50 rounded-xl" href="/">Home</a></li>
                  <li class="mb-1 px-10"><a class="block pl-8 py-4 text-xl text-gray-800 hover:bg-blueGray-50 rounded-xl" href="/oss">Open Source</a></li>
                  <li class="mb-1 px-10"><a class="block pl-8 py-4 text-xl text-gray-800 hover:bg-blueGray-50 rounded-xl" href="/blogs">Blogs</a></li>
                  <li class="mb-1 px-10"><a class="block pl-8 py-4 text-xl text-gray-800 hover:bg-blueGray-50 rounded-xl" href="/contact">Contact</a></li>
                </ul>
              </div>
              <div class="mt-auto px-10">
                <div class="pt-6"><a class="block mb-4 py-4 px-12 text-gray-800 text-center font-bold border border-gray-50 hover:border-gray-100 rounded-full" href="#">Sign in</a><a class="block py-4 px-12 text-white text-center font-bold bg-blue-500 hover:bg-blue-600 rounded-full transition duration-200" href="#">Sign up</a></div>
                <p class="mt-6 mb-4 text-lg text-center"><span>2004-2021 © IntelliFactory. All rights reserved.</span></p>
              </div>
            </nav>
          </div>
        </section>
        
      </div>
      <section class="py-20 2xl:py-40 bg-blue-800 overflow-hidden">
        <div class="container px-4 mx-auto">
          <div class="max-w-4xl mx-auto text-center">
            <h2 class="mb-14 text-6xl lg:text-7xl font-bold font-heading text-white">Deploying a .NET Core WebSharper site in AWS Lambda</h2>
            <div class="inline-flex mb-14 lg:mb-20 items-center"><img class="mr-8 w-20 lg:w-24 h-20 lg:h-24 rounded-full" src="/img/avatar/jankoa.png" alt="Andras Janko" />
              <div class="flex-1 text-left">
                <h4 class="mb-1 text-2xl font-bold text-gray-50">Andras Janko</h4>
                <p class="text-white">Feb 21, 2018</p>
              </div>
              <div class="text-right ml-20">
                <p class="mb-1 font-bold text-gray-50 text-xl">Reading time:</p>
                <p class="text-white">7 mins</p>
              </div>
            </div>
          </div>
          <div class="relative h-96 mb-20"><img class="w-full h-full object-cover" src="/img/category3.jpg" alt="" /></div>
          <div class="max-w-4xl mx-auto markdown"><div ws-preserve=""><p>With the .NET Core support added to AWS lambda, it is a great platform to run services or sites that are stateless and lightweight.
A free AWS account is enough to try this, up to one million requests per month. <a href="https://github.com/dotnet-websharper/core">WebSharper 4.2</a>'s new .NET Core templates can be quickly configured to be published on Lambda.</p>
<p>You can use <a href="https://docs.aws.amazon.com/sdk-for-net/v3/developer-guide/net-dg-signup.html">this guide</a> for signing up for an AWS account, and to download and configure your credentials for use by the command tool or the AWS Toolkit for Visual Studio.</p>
<h2 id="setting-up">Setting up</h2>
<p>First, install the templates if you don't have them yet, with:</p>
<pre><code>dotnet new -i WebSharper.Templates
</code></pre>
<p>Create a new empty folder, with the name you want for your project (for example <code>LambdaWS</code>) and run one of:</p>
<pre><code>-- to create a C# site:
dotnet new websharper-web 
-- to create an F# site:
dotnet new websharper-web -lang f#
</code></pre>
<p>Next, adding some packages:</p>
<pre><code>dotnet add package Microsoft.AspNetCore.All -v 2.0.3
dotnet add package Amazon.Lambda.AspNetCoreServer
dotnet add package AWSSDK.Extensions.NETCore.Setup
</code></pre>
<p>The <code>AWSSDK.Extensions.NETCore.Setup</code> will be only needed if you want to use other AWS services like S3 or DynamoDB.
Although <code>Microsoft.AspNetCore.All</code> is already installed for the template, AWS Lambda supports it only up to version 2.0.3, so it needs to be downgraded.</p>
<p>To get access to the <code>dotnet lambda</code> CLI, we also need a <code>DotNetCliToolReference</code> in the project file, add this inside the root <code>Project</code> node:</p>
<pre><code>  &lt;ItemGroup&gt;
    &lt;DotNetCliToolReference Include=&quot;Amazon.Lambda.Tools&quot; Version=&quot;2.1.0&quot; /&gt;
  &lt;/ItemGroup&gt;
</code></pre>
<p>Then run <code>dotnet restore</code> to install the CLI tool. (<a href="https://github.com/NuGet/Home/issues/4901">Eventually</a> this will all be done automatically by <code>dotnet install tool -g Amazon.Lambda.Tools</code>)</p>
<h2 id="adding-the-entry-point">Adding the entry point</h2>
<p>Open your <code>Program.cs</code> or <code>Program.fs</code> file, and add this new class that will work as the entry point for the Lambda function.
You can leave the existing <code>Program</code> class/module, so the application will continue to run locally with Kestrel or in IIS too.</p>
<p>For C#:</p>
<pre><code class="language-csharp">public class LambdaEntryPoint : Amazon.Lambda.AspNetCoreServer.APIGatewayProxyFunction 
{
    protected override void Init (IWebHostBuilder builder)
    {
        builder.UseStartup&lt;Startup&gt;();
    }
}
</code></pre>
<p>For F#:</p>
<pre><code class="language-fsharp">type LambdaEntryPoint() =
    inherit Amazon.Lambda.AspNetCoreServer.APIGatewayProxyFunction()
    
    override this.Init(builder) =
        builder.UseStartup&lt;Startup&gt;() |&gt; ignore
</code></pre>
<h2 id="adding-a-serverless.template">Adding a serverless.template</h2>
<p>For multi-page applications to run correctly, we need separate AWS Lambda functions to handle the root and the sub-paths.
The easiest way to manage this is by using AWS CloudFormation, which enables handling multipe service installations under a single stack name.
Create a file called <code>serverless.template</code>, and add this as content:</p>
<pre><code>{
  &quot;AWSTemplateFormatVersion&quot; : &quot;2010-09-09&quot;,
  &quot;Transform&quot; : &quot;AWS::Serverless-2016-10-31&quot;,
  &quot;Description&quot; : &quot;An AWS Serverless Application.&quot;,

  &quot;Resources&quot; : {

    &quot;ProxyFunction&quot; : {
      &quot;Type&quot; : &quot;AWS::Serverless::Function&quot;,
      &quot;Properties&quot;: {
        &quot;Handler&quot;: &quot;LambdaWS::LambdaWS.LambdaEntryPoint::FunctionHandlerAsync&quot;,
        &quot;Runtime&quot;: &quot;dotnetcore2.0&quot;,
        &quot;CodeUri&quot;: &quot;&quot;,
        &quot;MemorySize&quot;: 512,
        &quot;Timeout&quot;: 30,
        &quot;Role&quot;: null,
        &quot;Policies&quot;: [ &quot;AWSLambdaFullAccess&quot; ],
        &quot;Environment&quot; : {
          &quot;Variables&quot; : {
          }
        },
        &quot;Events&quot;: {
          &quot;PutResource&quot;: {
            &quot;Type&quot;: &quot;Api&quot;,
            &quot;Properties&quot;: {
              &quot;Path&quot;: &quot;/{proxy+}&quot;,
              &quot;Method&quot;: &quot;ANY&quot;
            }
          }
        }
      }
    },
    
    &quot;RootPathFunction&quot; : {
      &quot;Type&quot; : &quot;AWS::Serverless::Function&quot;,
      &quot;Properties&quot;: {
        &quot;Handler&quot;: &quot;LambdaWS::LambdaWS.LambdaEntryPoint::FunctionHandlerAsync&quot;,
        &quot;Runtime&quot;: &quot;dotnetcore2.0&quot;,
        &quot;CodeUri&quot;: &quot;&quot;,
        &quot;MemorySize&quot;: 512,
        &quot;Timeout&quot;: 30,
        &quot;Role&quot;: null,
        &quot;Policies&quot;: [ &quot;AWSLambdaFullAccess&quot; ],
        &quot;Events&quot;: {
          &quot;PutResource&quot;: {
            &quot;Type&quot;: &quot;Api&quot;,
            &quot;Properties&quot;: {
              &quot;Path&quot;: &quot;/&quot;,
              &quot;Method&quot;: &quot;ANY&quot;
            }
          }
        }
      }
    }
  },

  &quot;Outputs&quot; : {
  }
}
</code></pre>
<p>Modify assembly and namespace name from <code>LambdaWS</code> to the name of your project if different.</p>
<h2 id="deployment">Deployment</h2>
<p>We are ready to deploy our first test site. It can be done both from command line or using Visual Studio.
First let's keep using the command line. (You can jump ahead to use Visual Studio for a quicker setup.)
Run this with your profile name:</p>
<pre><code>dotnet lambda deploy-serverless --configuration Release --framework netcoreapp2.0 --profile YourProfileName
</code></pre>
<p>This will ask for multiple additional inputs.
First the name of the stack. You can give a unique name to create a new one.
Then the name of an S3 bucket. Create one in <a href="https://s3.console.aws.amazon.com/s3/">AWS Console</a> for the region you are targeting and paste its name.
Next the serverless template file, enter <code>serverless.template</code>.
Last the region where you want to deploy to (for example <code>us-east-2</code>, must be where your S3 bucket is located).</p>
<p>After the deployment finishes, you can check your Lambda functions in <a href="https://console.aws.amazon.com/lambda/">AWS Console</a> to find the <code>RootPathFunction</code> belonging to the newly deployed stack.
Click it then <code>API Gateway</code>, scroll down to see its properties and open dropdown to see the Invoke URL where you can reach your application.</p>
<p><img src="https://i.imgur.com/Em5ky7e.png" alt="Deployed app" /></p>
<h2 id="deploying-and-configuring-via-aws-toolkit">Deploying and configuring via AWS Toolkit</h2>
<p>If you are using Visual Studio, it is helpful to install the <a href="https://aws.amazon.com/visualstudio/">AWS Toolkit for Visual Studio</a>.
This adds the AWS Explorer to view and manage your deployed resources, and also right-click commands for the Solution Explorer to deploy projects.
Clicking <code>Publish to AWS Lambda...</code> on the project node opens a dialog where you can set your AWS account, region and stack name. These will all get saved automatically to a <code>aws-lambda-tools-defaults.json</code> file upon publishing, so you don't need to specify them again when updating.</p>
<p><img src="https://i.imgur.com/CUmac84.png" alt="Publish dialog" /></p>
<p>Click <code>Publish</code> and when status is displaying <code>CREATE_COMPLETE</code>, you can click the link at <code>AWS Serverless URL</code> to see the sample page running.</p>
<p><img src="https://i.imgur.com/berW90e.png" alt="Publish result" /></p>
<h2 id="to-be-continued">To be continued</h2>
<p>We will be picking it up from here with:</p>
<ul>
<li>Optimizing deployment so that static files are using S3 instead of the lambda function (more cost effective).</li>
<li>Using S3 from within a lambda function.</li>
<li>Creating a JSON API in WebSharper to run on Lambda.</li>
<li>Logging and configuration integration with Lambda.</li>
</ul>
</div></div>
        </div>
      </section>
      <section class="2xl:py-20 py-5">
        <div class="container mx-auto px-4">
          <div class="flex flex-wrap -mx-4 border-b border-gray-100 pt-5 lg:pt-10">
            <div class="w-full lg:w-3/5 px-4">
              <div class="flex flex-wrap -mx-4">
                <div class="w-1/2 lg:w-1/3 px-4 mb-12">
                  <h3 class="mb-8 lg:mb-10 text-xl font-bold font-heading">IntelliFactory</h3>
                  <ul class="text-lg">
                    <li class="mb-4"><a class="hover:underline" href="/jobs">Jobs</a></li>
                    <li class="mb-4"><a class="hover:underline" href="/blogs">Blogs</a></li>
                    <li class="mb-4"><a class="hover:underline" href="/privacy-policy">Privacy Policy</a></li>
                    <li class="mb-4 Cookies"><a class="hover:underline" href="/cookie-policy">Cookies</a></li>
                    <li><a class="hover:underline" href="#">Contact</a></li>
                  </ul>
                </div>
                <div class="w-full lg:w-1/3 px-4 mb-4">
                  <h3 class="mb-8 lg:mb-10 text-xl font-bold font-heading">Services</h3>
                  <ul class="text-lg">
                    <li class="mb-4"><a class="hover:underline" href="/home#consulting">Consulting</a></li>
                    <li class="mb-4"><a class="hover:underline" href="/home#development">Development</a></li>
                    <li class="mb-4"><a class="hover:underline" href="/home#code-synthesis">AI-driven Code Synthesis</a></li>
                    <li class="mb-4"><a class="hover:underline" href="/home#dsls">Domain-Specific Languages</a></li>
                  </ul>
                </div>
                <div class="w-1/2 lg:w-1/3 px-4 mb-12">
                  <h3 class="mb-8 lg:mb-10 text-xl font-bold font-heading">Open Source</h3>
                  <ul class="text-lg">
                    <li class="mb-4"><a class="hover:underline" href="https://websharper.com">WebSharper</a></li>
                    <li class="mb-4"><a class="hover:underline" href="https://fsbolero.io">Bolero</a></li>
                    <li class="mb-4"><a class="hover:underline" href="#">From our Lab</a></li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="w-full lg:w-2/5 px-4 order-first lg:order-last mb-16 lg:mb-0">
              <h3 class="mb-10 text-xl font-bold">Newsletter</h3>
              <form action="#">
                <div class="md:max-w-sm mb-8 flex items-center bg-white border border-gray-100 rounded-full"><span class="inline-block pl-2 lg:pl-5">
                    <svg width="37" height="37" viewbox="0 0 37 37" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="18.5" cy="18.5" r="9.5" fill="#1F40FF" fill-opacity="0.15"></circle>
                      <circle cx="18.5" cy="18.5" r="18.5" fill="#1F40FF" fill-opacity="0.06"></circle>
                      <circle cx="18.5" cy="18.5" r="2.5" fill="#282C36"></circle>
                    </svg></span>
                  <input class="pl-4 py-2 rounded-full placeholder-gray-900 font-bold" type="email" placeholder="Your email address" />
                  <button class="ml-auto px-6 lg:px-8 py-4 text-white font-bold bg-blue-500 hover:bg-blue-600 rounded-full transition duration-200">Ok</button>
                </div>
                <p class="text-gray-300">We will not spam you or give your details to anyone.</p>
              </form>
            </div>
          </div>
          <div class="flex flex-wrap items-center mb-8 lg:mb-0 pt-5">
            <div class="w-full md:w-3/4 mb-8 md:mb-0">
              <div class="md:flex items-center"><a class="inline-block text-gray-900 text-xl font-bold" href="#"><img class="h-7" src="/files/logos/zospace-dark-logo.svg" alt="" width="auto" /></a>              <span class="hidden md:inline-block mx-8 w-px h-8 bg-gray-50"></span>
                <p class="hidden lg:block text-sm"><span>© 2004-2021 IntelliFactory.</span>                <span class="text-gray-300">All rights reserved.</span></p>
              </div>
            </div>
            <div class="w-full md:w-1/4">
              <div class="md:flex items-center justify-end"><a class="inline-block mr-2" href="https://github.com/intellifactory">
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewbox="0 0 24 24">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path>
                  </svg></a>              <a class="inline-block mr-2" href="https://facebook.com/intellifactory">
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewbox="0 0 24 24" fill="#3b5998">
                    <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm3 8h-1.35c-.538 0-.65.221-.65.778v1.222h2l-.209 2h-1.791v7h-3v-7h-2v-2h2v-2.308c0-1.769.931-2.692 3.029-2.692h1.971v3z"></path>
                  </svg></a>              <a class="inline-block mr-2" href="https://twitter.com/intellifactory">
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewbox="0 0 24 24" fill="#00acee">
                    <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"></path>
                  </svg></a>              <a class="inline-block mr-2" href="https://www.linkedin.com/company/intellifactory">
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewbox="0 0 24 24" fill="#0e76a8">
                    <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-2 16h-2v-6h2v6zm-1-6.891c-.607 0-1.1-.496-1.1-1.109 0-.612.492-1.109 1.1-1.109s1.1.497 1.1 1.109c0 .613-.493 1.109-1.1 1.109zm8 6.891h-1.998v-2.861c0-1.881-2.002-1.722-2.002 0v2.861h-2v-6h2v1.093c.872-1.616 4-1.736 4 1.548v3.359z"></path>
                  </svg></a>              <a class="inline-block" href="https://vimeo.com/user15828007">
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewbox="0 0 24 24" fill="#86c9ef">
                    <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.82 11.419c-1.306 2.792-4.463 6.595-6.458 6.595-1.966 0-2.25-4.192-3.324-6.983-.527-1.372-.868-1.058-1.858-.364l-.604-.779c1.444-1.27 2.889-2.745 3.778-2.826.998-.096 1.615.587 1.845 2.051.305 1.924.729 4.91 1.472 4.91.577 0 2.003-2.369 2.076-3.215.13-1.24-.912-1.277-1.815-.89 1.43-4.689 7.383-3.825 4.888 1.501z"></path>
                  </svg></a></div>
              <div class="md:flex items-center justify-end"><a class="inline-block mr-2" href="#"><img src="/files/logos/facebook.svg" alt="" /></a>              <a class="inline-block mr-2" href="#"><img src="/files/logos/instagram.svg" alt="" /></a>              <a class="inline-block" href="#"><img src="/files/logos/twitter.svg" alt="" /></a></div>
            </div>
          </div>
        </div>
      </section>
      
      <div>
        
        <meta id='websharper-data' name='websharper-data' content='{"$TYPES":[],"$DATA":{"$V":{}}}' />
<script src="../../Scripts/WebSharper.Core.JavaScript/Runtime.js" type="text/javascript" charset="UTF-8"></script><script type="text/javascript">
if (typeof IntelliFactory !=='undefined') {
  IntelliFactory.Runtime.ScriptBasePath = '../../Scripts/';
  IntelliFactory.Runtime.Start();
}
</script>

        <script src="/js/Dynamic%24%7BReleaseMin%7D.js"></script>
      </div>
    </div>
  </body>
</html>